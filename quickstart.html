<!DOCTYPE html>
<html>

<head>
  <title>Drive API Quickstart</title>
  <meta charset='utf-8' />
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://apis.google.com/js/platform.js" async defer></script>
</head>

<body>
  <p>Drive API Quickstart</p>

  <!--Add buttons to initiate auth sequence and sign out-->
  <button id="authorize-button" style="display: none;">Authorize</button>
  <button id="signout-button" style="display: none;">Sign Out</button>

  <br>

  <button id="save-buton">Save File</button>

  <div class="g-savetodrive"
    data-src="https://storage.googleapis.com/openscreenshot/z/T/h/SkjtAKhTz.png"
    data-filename="My Statement.png"
    data-sitename="My Company Name">
  </div>

  <pre id="content"></pre>

  <script type="text/javascript">
    // Client ID and API key from the Developer Console
    var CLIENT_ID = '';
    var API_KEY = '';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    var SCOPES = 'https://www.googleapis.com/auth/drive';

    var authorizeButton = document.getElementById('authorize-button');
    var signoutButton = document.getElementById('signout-button');

    let auth_token;

    /**
     *  On load, called to load the auth2 library and API client library.
     */
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

        auth_token = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;

        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
      });
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
        // listFiles();
      } else {
        authorizeButton.style.display = 'block';
        signoutButton.style.display = 'none';
      }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
      var pre = document.getElementById('content');
      var textContent = document.createTextNode(message + '\n');
      pre.appendChild(textContent);
    }

    /**
     * Print files.
     */
    function listFiles() {
      gapi.client.drive.files.list({
        'pageSize': 10,
        'fields': "nextPageToken, files(id, name)"
      }).then(function (response) {
        appendPre('Files:');
        var files = response.result.files;
        if (files && files.length > 0) {
          for (var i = 0; i < files.length; i++) {
            var file = files[i];
            appendPre(file.name + ' (' + file.id + ')');
          }
        } else {
          appendPre('No files found.');
        }
      });
    }

    /**
     * Save file.
     */
    document.getElementById('save-buton').addEventListener('click', saveFile);

    function saveFile() {
      const base64 = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgA
                AAAoAAAAKCAYAAACNMs+9AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJ
                TUUH1ggDCwMADQ4NnwAAAFVJREFUGJWNkMEJADEIBEcbSDkXUnfSg
                nBVeZ8LSAjiwjyEQXSFEIcHGP9oAi+H0Bymgx9MhxbFdZE2a0s9kT
                Zdw01ZhhYkABSwgmf1Z6r1SNyfFf4BZ+ZUExcNUQUAAAAASUVORK5
                CYII=`;

      fetch(base64)
        .then(res => res.blob())
        .then(blob => {
          const file = new File([blob], "File name");
          console.log(file);

          const boundary = '-------314159265358979323846';
          const delimiter = "\r\n--" + boundary + "\r\n";
          const close_delim = "\r\n--" + boundary + "--";

          const contentType = 'image/png';

          const metadata = {
            'name': 'Photo',
            'mimeType': contentType
          };

          const multipartRequestBody =
              delimiter +
              'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
              JSON.stringify(metadata) +
              delimiter +
              'Content-Type: ' + contentType + '\r\n\r\n' +
              file +
              close_delim;


          /* axios.post(
            'https://www.googleapis.com/upload/drive/v3/files',
            multipartRequestBody,
            {
              params: {
                'uploadType': 'multipart'
              },
              headers: {
                // 'Content-Type': 'image/png',
                'Content-Type': 'multipart/related; boundary="' + boundary + '"',
                'Authorization': `Bearer ${auth_token}`
              }
            }
          ).then(
            res => {
              console.log(res);
            },
            console.error
          ); */

          axios.post(
            'https://www.googleapis.com/upload/drive/v3/files',
            file,
            {
              params: {
                'uploadType': 'media'
              },
              headers: {
                'Content-Type': 'image/png',
                'Authorization': `Bearer ${auth_token}`
              }
            }
          ).then(
            res => {
              console.log(res);

              axios.patch(
                `https://www.googleapis.com/drive/v3/files/${res.data.id}`,
                {
                  name: `Photo ${new Date().getTime()}`
                },
                {
                  headers: {
                    'Authorization': `Bearer ${auth_token}`
                  }
                }
              )
            },
            console.error
          )
        })
    }

  </script>

  <script async defer src="https://apis.google.com/js/api.js" 
  onload="this.onload=function(){};handleClientLoad()" 
  onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
</body>

</html>